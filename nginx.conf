server_names_hash_bucket_size 64;
gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
ssl_prefer_server_ciphers On;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
ssl_ciphers "EECDH+aRSA+AESGCM EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA !aNULL !eNULL !LOW !MEDIUM !SEED !3DES !CAMELLIA !MD5 !EXP !PSK !SRP !DSS !RC4";


upstream ct-watch-www {
	server 172.17.42.1:8081;
}

upstream ct-watch-http {
	server 172.17.42.1:8088;
}

upstream blog {
	server blog-origin.tom-fitzhenry.me.uk:80;
}

upstream btsync {
    server 172.17.42.1:8888;
}

server {
    listen *:80 default_server;
    return 404;
}

server {
	listen 0.0.0.0:80;
	server_name ct-watch.tom-fitzhenry.me.uk;
	location / {
		rewrite  ^/$  /index.html  last;
		proxy_pass http://ct-watch-www;
	}
}

server {
	listen 0.0.0.0:80;
	server_name api.ct-watch.tom-fitzhenry.me.uk;
	location / {
		proxy_pass http://ct-watch-http;
	}
}

server {
    listen 0.0.0.0:443 ssl;
    server_name btsync.tom-fitzhenry.me.uk;
	ssl on;
	ssl_certificate /etc/nginx/ssl/blog.tom-fitzhenry.me.uk.crt;
	ssl_certificate_key /etc/nginx/ssl/blog.tom-fitzhenry.me.uk.key;
    location / {
        proxy_pass http://btsync;
    }
}

server {
	listen 0.0.0.0:443 ssl;
	server_name blog.tom-fitzhenry.me.uk;
	ssl on;
	ssl_certificate /etc/nginx/ssl/blog.tom-fitzhenry.me.uk.crt;
	ssl_certificate_key /etc/nginx/ssl/blog.tom-fitzhenry.me.uk.key;
    add_header Strict-Transport-Security "max-age=15552000; includeSubdomains";
	location / {
		proxy_pass http://blog;
        proxy_set_header Host "blog-origin.tom-fitzhenry.me.uk";
	}
}

server {
    listen 0.0.0.0:443 ssl;
    server_name notes.tom-fitzhenry.me.uk;
    location / {
        proxy_pass https://tomfitzhenry.github.io/notes;
    }
}

server {
    listen 0.0.0.0:80;
    server_name tom-fitzhenry.me.uk;
    add_header Strict-Transport-Security "max-age=15552000";
    location / {
        return 301 https://www.tom-fitzhenry.me.uk$request_uri;
    }
}

server {
    listen 0.0.0.0:443 ssl;
    server_name tom-fitzhenry.me.uk;
    ssl on;
    ssl_certificate /etc/nginx/ssl/www.tom-fitzhenry.me.uk.crt;
    ssl_certificate_key /etc/nginx/ssl/www.tom-fitzhenry.me.uk.key;
    add_header Strict-Transport-Security "max-age=15552000; includeSubdomains";
    location / {
        return 301 https://www.tom-fitzhenry.me.uk$request_uri;
    }
}

server {
    listen 0.0.0.0:80;
    server_name www.tom-fitzhenry.me.uk;
    add_header Strict-Transport-Security "max-age=15552000; includeSubdomains";
    location / {
        return 301 https://www.tom-fitzhenry.me.uk$request_uri;
    }
}

server {
    listen 0.0.0.0:443 ssl;
    server_name www.tom-fitzhenry.me.uk;
    ssl on;
    ssl_certificate /etc/nginx/ssl/www.tom-fitzhenry.me.uk.crt;
    ssl_certificate_key /etc/nginx/ssl/www.tom-fitzhenry.me.uk.key;
    add_header Strict-Transport-Security "max-age=15552000; includeSubdomains";

    location = / {
        return 302 https://blog.tom-fitzhenry.me.uk;
    }

    location = /robots.txt {
        return 302 https://blog.tom-fitzhenry.me.uk/robots.txt;
    }

    location = /blog {
        return 301 https://blog.tom-fitzhenry.me.uk/;
    }

    location ~ ^/blog/(?<rest>.*)$ {
        return 301 https://blog.tom-fitzhenry.me.uk/$rest;
    }

}
